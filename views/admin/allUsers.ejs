<%- include('../layout/admin/header')%>
<header>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container">
            <!-- Left Side - Images -->
            <div class="d-flex align-items-center"> <!-- Added align-items-center class -->
                <div class="headOne">
                    <a class="navbar-brand" href="#">
                        <img src="./images/adminpage/Homy-logos_transparent.png" alt="Logo" width="120"  height="100" class="d-inline-block align-text-top">
                    </a>
                </div>
                <div class="headTwo mx-auto d-flex justify-content-center align-items-center w-100"> <!-- Added w-100 class for 100% width -->
                    <a class="navbar-brand" href="#">
                        <img src="./images/adminpage/homy.png" style="margin-left: 420px" alt="Logo" width="180" height="100" class="d-inline-block align-text-top">
                    </a>
                </div>
            </div>
        </div>
    </nav>
    <nav class="navbar bg-body-warning fixed-top-10px">
        <div class="container mt-2 mb-2">
          <!-- <a class="navbar-brand" href="#">Offcanvas navbar</a> -->
          <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
            <div class="offcanvas-header">
              <h3 class="offcanvas-title mt-3 " id="offcanvasNavbarLabel">Homy Admin Panel</h3>
              <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body m-3 ">
                <form class="d-flex mt-3" role="search">
                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                    <button class="btn btn-outline-success" type="submit">Search</button>
                  </form>
              <ul class="navbar-nav justify-content-end flex-grow-1 pe-3 mt-5 ">
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="/admin/dashboard">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/admin/allOrders">All Orders</a>
                  </li>
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="#">Users</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/admin/allProducts">Products</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/admin/allCategory">Categories</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/admin/allOffers">Offers</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/admin/allCoupons">Coupons</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/admin/allBanners">Banners</a>
                  </li>
                  
              </ul>
              
            </div>
          </div>
          <div class="custom-background d-flex justify-content-between align-items-center">
            <div class="navOne">
              <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item    mt-3 ms-3 "><a href="/admin/dashboard" class="text-light">Dashboard</a></li>
                  <li class="breadcrumb-item active  mt-3 text-light       " aria-current="page">Users</li>
                </ol>
              </nav>
            </div>
            <div class="navTwo d-flex align-items-center">
                <span class="me-3 text-light">Hi, Sreekuttan</span> 
                <form action="/admin/logout"  method="post">
                  <input type="submit" class="btn mt-2 text-light mb-2 " value="Logout">
              </form>
            </div>
        </div>
        </div>
      </nav>
</header>
<section>
  <div class="container">
    
    <div class="row">
      <div class="cols col-3">
          <h3>All Users</h3>
      </div>
      <div class="cols col-3 d-flex">

      </div>
      <!-- <div class="cols col-3 d-flex">
          <form class="d-flex mt-3" role="search">
            <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-success" type="submit">Search</button>
          </form>
      </div> -->
      <div class="cols col-3 d-flex">
       
        <!-- <button type="button" class="btn align text-bg-primary  text-light rounded-0 ms-auto" id="addNewUser"><a href="/admin/addUser" class="text-light " >Add New User</a></button> -->
    </div>
  </div>



    <table class="table mt-3">
        <thead class="table-light">

         
          <th>User ID</th>
          <th>Name</th>
          <th>Image</th>
          <th>Mobile</th>
          <th>Email</th>
          <!-- <th>Details</th> -->
          <th>Block Status</th>
          <th>Delete</th>
        </thead>
       
          <tbody>
            <tr>



            <%
                    if(users.length>0)
                    {
                      for(let i=0;i<users.length;i++)
                      {
                        %>
                        <tr>
                         
                          <td>12345</td>
                          
                          <td><%= users[i].name%></td>
                          <td><img src="./images/userpage/user.jpg" alt="<%= users[i].image%>" width="50px" height="50px"></td>
                          <td><%= users[i].mobile%></td>
                          <td><%= users[i].email%></td>
                          <!-- <td>
                            <button type="button" class="btn bg-success w-75   text-light  rounded-0 " 
                            data-bs-toggle="modal" data-bs-target="#staticBackdropDelete" 
                            data-product-id="<%= users[i]._id %>">Details</button>
                          </td> -->
                          
                          <td>
                            <%if(users[i].isBlocked)
                            {%>

                              <button type="button" class="btn bg-secondary    w-75 text-light rounded-0" data-product-id="<%= users[i]._id %>" data-product-isBlocked="<%= users[i].isBlocked %>" id="BlockButton<%= users[i]._id %>">UnBlock</button>

                            <%} else { %>

                              <button type="button" class="btn bg-warning    w-75 text-light rounded-0" data-product-id="<%= users[i]._id %>" data-product-isBlocked="<%= users[i].isBlocked %>" id="BlockButton<%= users[i]._id %>">Block</button>

                            <%}%>

                          </td>
                        


                        
                        
                          <td>
                            <button type="button" class="btn bg-danger w-75 text-light  rounded-0 " 
                            data-bs-toggle="modal" data-bs-target="#staticDelete" data-user-name="<%= users[i].name %>"
                            data-user-id="<%= users[i]._id %>" >Delete</button>
                          </td>
                           
                    <% 
                        }
                      }
                      %>
                      </tr>

        </tbody>
      </table>
    </div>




</section>
<section>
     <!-- Modal three Delete-->
     <div class="modal fade" id="staticDelete" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            
              <div class="modal-body">
                <h1 class="modal-title fs-5  visually-hidden  "  id="staticBackdropLabel"></h1>
                  <div class="mb-3 row">
                     
                      <div class="col-sm-10">
                          
                          <div class="d-flex flex-wrap">
                              <h4 class="text-primary   ">Confirm Delete ?</h4>
                              
                          </div>
                      </div>
                  </div>  
              </div>
              <div class="modal-footer d-flex justify-content-center">
                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
               
                 <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdropDeleteSuccess" id="confirmDeleteButton">Confirm</button></a>
             
              </div>
             
          </div>
      </div>
    </div>
    
    <!-- Modal three end-->
      <!-- Modal three-success start-->
      <div class="modal fade" id="staticBackdropDeleteSuccess" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
               
                <div class="modal-body">
                    
                    <div class="mb-3 row">
                       
                        <div class="col-sm-10">
                            
                          <div class="d-flex flex-wrap justify-content-center text-center">
                            <h4 class="text-success">Deleted Successfully</h4>
                        </div>
                        
                        </div>
                    </div>  
                </div> 
                  <div class="modal-footer d-flex justify-content-center">
                    <a href="" data-bs-toggle="modal" ><button type="button" class="btn btn-primary " data-bs-dismiss="modal">OK</button></a>
               
                </div>
            </div>
        </div>
      </div>
      
      <!-- Modal three-success end-->
      </section>

<!-- block user -->

<script>
  const blockButtons = document.querySelectorAll('[id^="BlockButton"]');
  
blockButtons.forEach(button => {
  const userId = button.dataset.productId;
  const buttonValue=button.getAttribute('data-product-isBlocked')
  console.log(buttonValue)
   
  let isBlocked=buttonValue
 
  isBlocked = !isBlocked;

  button.addEventListener('click', (e) => {
    e.preventDefault()

    const swalWithBootstrapButtons = Swal.mixin({
        customClass: {
          confirmButton: "btn btn-success",
          cancelButton: "btn btn-danger"
        },
        buttonsStyling: false
      });
      swalWithBootstrapButtons.fire({
        title: "Are you Sure ?",
        text: "",
        icon: "",
        showCancelButton: true,
        confirmButtonText: "Confirm",
        cancelButtonText: "Cancel",
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          console.log(isBlocked+"ONE")
          isBlocked = !isBlocked;
          console.log(isBlocked+"TWO")
          updateButtonTextAndColor(button, isBlocked);
          console.log(isBlocked + " yes "+userId)
          fetch(`/admin/blockUser/${userId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ isBlocked: isBlocked }),
          })
            .then((response) => response.json())
            .then((data) => {
              
              console.log('User updated:', data);
              
              
            })
            .catch((error) => {
            
              console.error('Error updating user:', error);
            });


            function updateButtonTextAndColor(button, isBlocked) {

      button.textContent = (isBlocked===true) ? "UnBlock" : "Block";
      button.classList.toggle('bg-secondary', isBlocked);
      button.classList.toggle('bg-warning', !isBlocked);
      }
      let timerInterval;
      Swal.fire({
        title: "Successfully Blocked",
        html: "",
        icon:"success",
        timer: 600,
        timerProgressBar: true,
        didOpen: () => {
          Swal.showLoading();
          const timer = Swal.getPopup().querySelector("b");
          timerInterval = setInterval(() => {
            timer.textContent = `${Swal.getTimerLeft()}`;
          }, 100);
        },
        willClose: () => {
          clearInterval(timerInterval);
        }
      }).then((result) => {
        /* Read more about handling dismissals below */
        if (result.dismiss === Swal.DismissReason.timer) {
          console.log("I was closed by the timer");
        }
      });
        } else if (
          /* Read more about handling dismissals below */
          result.dismiss === Swal.DismissReason.cancel
        ) {
          let timerInterval;
        Swal.fire({
          title: "Cancelled",
          html: "",
          timer: 400,
          timerProgressBar: true,
          didOpen: () => {
            Swal.showLoading();
            const timer = Swal.getPopup().querySelector("b");
            timerInterval = setInterval(() => {
              timer.textContent = `${Swal.getTimerLeft()}`;
            }, 100);
          },
          willClose: () => {
            clearInterval(timerInterval);
          }
        }).then((result) => {
          /* Read more about handling dismissals below */
          if (result.dismiss === Swal.DismissReason.timer) {
            console.log("I was closed by the timer");
          }
        });
        }
      });


  });
});


</script>





<!-- add user -->
<script>
  const addNewUser=document.getElementById('addNewUser')

  if(addNewUser)
  {
    addNewUser.addEventListener('click',event=>{

      fetch('/admin/addUser', {
          method: '', 
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Error: ${response.status} - ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log(data); 
          window.location.href = '/admin/allProducts'; 
        })
        .catch(error => {
          console.error('Error:', error);
         
        });

    })
  }
</script>



<script>
  //delete
  const staticDelete = document.getElementById('staticDelete');

  if (staticDelete) {
    staticDelete.addEventListener('show.bs.modal', event => {
      const button = event.relatedTarget;
      const userId = button.getAttribute("data-user-id");
      const userName = button.getAttribute('data-user-name');

      const modalTitle = staticDelete.querySelector('.modal-title');
      const confirmButton = staticDelete.querySelector('#confirmDeleteButton');
      console.log("hello")
      modalTitle.textContent = `Delete User ${userName}`;
      console.log(userId+"hello")
      confirmButton.addEventListener('click', () => {
     
        console.log(userId)
        const deleteUrl = `/admin/deleteUser?id=${userId}`;
        console.log(deleteUrl)
        fetch(deleteUrl, {
          method: 'DELETE', 
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Error: ${response.status} - ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log(data); 
          window.location.href = '/admin/allUsers'; 
        })
        .catch(error => {
          console.error('Error:', error);
         
        });
      });
    });
  }
</script>





<%- include('../layout/admin/footer')%>